<!DOCTYPE html>
<html lang="en-US">
	<head>
		<title>Rattrap, dynamic rendered objects</title>
		<!-- BEGIN META -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="keywords" content="your,keywords">
		<meta name="description" content="Short explanation about this website">
		<!-- END META -->

		<!-- BEGIN STYLESHEETS -->
		<link href='http://fonts.googleapis.com/css?family=Roboto:300italic,400italic,300,400,500,700,900' rel='stylesheet' type='text/css'/>
		<link type="text/css" rel="stylesheet" href="assets/css/theme-default/bootstrap.css?1422792965" />
		<link type="text/css" rel="stylesheet" href="assets/css/theme-default/materialadmin.css?1425466319" />
		<link type="text/css" rel="stylesheet" href="assets/css/theme-default/font-awesome.min.css?1422529194" />
		<link type="text/css" rel="stylesheet" href="assets/css/theme-default/material-design-iconic-font.min.css?1421434286" />
		<link type="text/css" rel="stylesheet" href="assets/css/theme-default/libs/rickshaw/rickshaw.css?1422792967" />
		<link type="text/css" rel="stylesheet" href="assets/css/theme-default/libs/morris/morris.core.css?1420463396" />
		<!-- END STYLESHEETS -->
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-resource.min.js"></script>
	</head>
	<body class="menubar-hoverable header-fixed">

		<!-- BEGIN HEADER-->
		<header id="header" >
			<div class="headerbar">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="headerbar-left">
					<ul class="header-nav header-nav-options">
						<li class="header-nav-brand" >
							<div class="brand-holder">
								<a href="../../html/dashboards/dashboard.html">
									<span class="text-lg text-bold text-primary">Rat Traps</span>
								</a>
							</div>
						</li>
						<li>
							<a class="btn btn-icon-toggle menubar-toggle" data-toggle="menubar" href="javascript:void(0);">
								<i class="fa fa-bars"></i>
							</a>
						</li>
					</ul>
				</div>
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="headerbar-right">
					<ul class="header-nav header-nav-options">
						<li>
							<!-- Search form -->
							<form class="navbar-search" role="search">
								<div class="form-group">
									<input type="text" class="form-control" name="headerSearch" placeholder="Search is not available yet!!">
								</div>
								<button type="submit" class="btn btn-icon-toggle ink-reaction"><i class="fa fa-search"></i></button>
							</form>
						</li>
				</div><!--end #header-navbar-collapse -->
			</div>
		</header>
		<!-- END HEADER-->

		<!-- BEGIN BASE-->
		<div id="base" ng-app="Rattrap" ng-controller="ProjectPresentation">

			<!-- BEGIN OFFCANVAS LEFT -->
			<div class="offcanvas">
			</div><!--end .offcanvas-->
			<!-- END OFFCANVAS LEFT -->

			<!-- BEGIN CONTENT-->
			<div id="content" >
				<section>
					<div class="section-body">
						<div class="row">

							<!-- BEGIN SITE ACTIVITY -->
							<div class="col-md-5 col-sm-5">
								<div class="card ">
									<div class="card-head">
										<header ng-bind="project.title"></header>
									</div><!--end .card-head -->
									<div class="card-body" >
										<img src="{{project.thumbnailurl}}" ng-model="project.thumbnail" value="{{project.thumbnailurl}}" width="430"/>
									</div>
								</div>
							</div>
							<div class="col-md-5 col-sm-5">
								<div class="card">
									<div class="card-head">
										<header>Project presentation</header>
									</div>
									<div class="card-body" ng-bind="project.presentation">
									</div><!--end .card-body -->
								</div>
							</div><!--end .col -->
							<!-- END SITE ACTIVITY -->
						</div>
						
						<div class="row">

							<!-- BEGIN TODOS -->
							<div class="col-md-5">
								<div class="card ">
									<div class="card-head">
										<header>Shape preview</header>
									</div><!--end .card-head -->
									<div class="card-body no-padding" ng-bind-html="dynamicPreview">
									</div><!--end .card-body -->
								</div><!--end .card -->
							</div><!--end .col -->
							<div class="col-md-5">
								<div class="card ">
									<div class="card-head">
										<header>Parameters</header>
									</div><!--end .card-head -->
									<div class="card-body">
											<form class="form">
												<div class="form-group" ng-repeat="parameter in project.parameters">
															<input ng-model="parameter.value" type="text" class="form-control">
															<label>{{parameter.displayname}}</label>
															<p class="help-block">{{parameter.description}}</p>
												</div>
											<button ng-click="preview()" class="btn btn-info">Preview</button>
											<button ng-click="downloadZip()" class="btn btn-info">Download</button>
											<button ng-click="reset()" class="btn btn-info">Reset</button>
											</form>
									</div>
								</div>
							</div>
						</div>
					</div>
							<!-- END TODOS -->
				</section>

			</div>
		</div>
		<script>

var app = angular.module("Rattrap", []);

app.controller("ProjectPresentation", function($scope, $http, $sce, $location, projectManager, renderDynamic) {
//fc98a674c91db1ff77e067f900aaa427
	var projectId = $location.search().projectId;
	var debug = $location.search().debug == "true";
	console.log("Loading project '" + projectId + "'")
	var parameters = [];
	for (var i = 0; i < 10; i++) {
		parameters.push({
			name: "parameter" + i,
			value: i,
			displayname: "Display Parameter " + i
		});
	}

	var emptyProject = {
		name: "Loading...",
		presentation: "Loading...",
		parameters: parameters,
		thumbnailurl: "temp_thumbnail.jpeg",
	};
	$scope.messages = "Loading...";
	$scope.project = emptyProject;
	
	projectManager.load($scope, $http, projectId);
	
	var renderPostBody = {
		projectid: projectId,
		width: 470,
		height: 470
	}
	
	renderDynamic.preview(renderPostBody, debug, $scope, $http, $sce);
	
	$scope.preview = function() {
		var customRenderPostBody = {
			projectid: projectId,
			width: 470,
			height: 470,
			parameters: $scope.project.parameters
		}
		renderDynamic.preview(customRenderPostBody, debug, $scope, $http, $sce);
	};
	
	$scope.reset = function() {
		projectManager.load($scope, $http, projectId);
		var renderPostBody = {
			projectid: projectId,
			width: 470,
			height: 470
		}
	
		renderDynamic.preview(renderPostBody, debug, $scope, $http, $sce);
	};
	
	$scope.downloadZip = function() {
		var customRenderPostBody = {
			projectid: projectId,
			width: 470,
			height: 470,
			parameters: $scope.project.parameters
		}
		renderDynamic.export(customRenderPostBody, debug, $scope, $http, $sce);
	};
	
	$scope.messages = "";

	
});

app.factory('renderDynamic', function () {
	return {
		preview: function(renderPostBody, debug, $scope, $http, $sce) {
			$scope.messages = "Rendering preview...";
			$http.post('http://localhost:8090/preview', renderPostBody).
			then(function successCallback(response) {
				$scope.dynamicPreview = $sce.trustAsHtml(response.data);
				if (debug) {
					console.log("'" + response.data + "'");
				}
			}, function errorCallback(response){
				$scope.dynamicPreview = $sce.trustAsHtml("Your chair parameters are invalid. Your chair will not be stable");
			});
			$scope.messages = "";
		},
		export: function(renderPostBody, debug, $scope, $http, $sce) {
			$scope.messages = "Rendering project...";
			$http.post('http://localhost:8090/render', renderPostBody, {
				dataType : "binary",
				processData : false,
				accept:'application/zip',
				Encoding: 'gzip',
				responseType:'arraybuffer'}).
			then(function successCallback(response) {
				var file = new Blob([response.data], {type: "application/octet-stream"})
				var url = window.URL.createObjectURL(file);

				var doc = document.createElement("a");
				doc.href = url;
				doc.download = renderPostBody.projectid + ".zip";
				doc.click();
				window.URL.revokeObjectURL(url);			
			}, function errorCallback(response){
				$scope.messages = "Error while downloading your rendered project";
			});
			$scope.messages = "";
		}
	}

});

app.factory('projectManager', function () {
	return {
		load: function($scope, $http, projectId) {
			$http.get('http://localhost:8090/project?id=' + projectId).
				then(function successCallback(response) {
					$scope.project = response.data;
			}, function errorCallback(response){
					$scope.project.name = "Error";
					console.log("Unable to perform get request");
			});
		}
	}

});
		</script>
</body>
</html>